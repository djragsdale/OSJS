<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>OS JS</title>
    </head>
    <body>
        <canvas id="terminal" width="768" height="576" tabindex="0">
        </canvas>
        
        <script>
            /*
            * Can read/write 2 types of files: text (*.txt) and batch (*.bat) files.
            * Saves those files in a database
            * Saves location of file in database
            * Saves file system structure in an XML file.
            * Can I make this OO and load in separated files?
            *  - I should separate out essential programs (like batch, echo, pause, and clear).
            *  - I should also have a <strike>main file</strike> and a bootloader file, the only files which will directly
            *    mention the HTML document.
            * Ideas:
            *  - Have a computer object which handles physical output.
            *  - Have a keyboard class which contacts the computer (like the controller of the architecture).
            *  - Have an os class which is a property of the computer object.
            *  - The os class will run the bootloader then wait for computer input (listen on a computer's port).
            *  - Should I have a run program that can take executable file names as a parameter and then give control over
            *    to the respective program?
            */

            var terminal = document.getElementById("terminal");
            var tContext = terminal.getContext("2d");

            var width = 768;
            var height = 576;
            var maxLines = 28;
            var fontSize = 16;
            var bgColor = "#303030";
            var fgColor = "#FFFFFF";
            var font = "Courier New";
            var lines = [];
            var currentLine = "";
            var commands = [];
            var currentScript = [];
            var currentProgram = [];

            var loadDefaultPrograms = function () {
                // Should probably run sql boot scripts loading the listed programs
                commands.push("ECHO");
                commands.push("BATCH");
                commands.push("PAUSE");
                commands.push("CLEAR");
            };

            onload = function () {
                var i = 0;
                setInterval(function () {
                    if (i % 10 === 0) {
                        draw(i);
                    }
                    i++;
                    if (i > 100) { i = 0; }
                }, 8);

                loadDefaultPrograms();
            };

            var draw = function (frame) {
                tContext.clearRect(0, 0, width, height);
                tContext.fillStyle = bgColor;
                tContext.fillRect(0, 0, width, height);

                tContext.moveTo(width * (0.02), height * (0.92));
                tContext.lineTo(width * (0.98), height * (0.92));
                tContext.strokeStyle = fgColor;
                tContext.stroke();

                if (frame > 49) {
                    writeLine("> " + currentLine + "_", width * (0.02), height * (0.97));
                }
                else { writeLine("> " + currentLine, width * (0.02), height * (0.97)); }

                for (var i = 0; i < lines.length; i++) {
                    writeLine(lines[i], width * (0.02), height * (0.07) + (i * (fontSize * 1.08)));
                }
            };


            var writeLine = function (text, x, y) {
                tContext.font = fontSize + "px " + font;
                tContext.fillStyle = fgColor;
                tContext.fillText(text, x, y);
            };

            var addLine = function (text) {
                lines.push(text);
                if (lines.length > maxLines) {
                    for (var i = 0; i < lines.length; i++) {
                        lines[i] = lines[i + 1];
                    }
                    lines.pop();
                }
            };

            var pause = function (seconds) {
                if (!isNaN(parseFloat(seconds))) {
                    //addLine(seconds); // at least calling the right section, but not really pausing yet...
                    setTimeout(seconds * 1000);
                    return 1;
                } else {
                    //addLine("NaN");
                    return 0;
                }
            };

            var clearLine = function () {
                lines.pop();
            };

            var clearAllLines = function () {
                lines = [];
            }

            var loadProgram = function (programTitle) {
                // push each line to the currentScript variable
                // do a SQL search for the programTitle ordered by the lineNbr
                currentProgram = [];
                if (programTitle == "ECHO") {
                    // Go ahead and figure out the code for the Echo program
                    // but I can use this for now
                    //currentScript.push("addLine(%param1%);");
                }
                else if (programTitle == "BATCH") {

                }
                else if (programTitle == "PAUSE") {

                }
                else if (programTitle == "CLEAR") {

                }

            };

            var executeCommand = function (command) {
                // addLine("command is executing...");
                var params = command.split(' ');
                // Doesn't work yet
                loadProgram(params[0]);

                // should execute the program, but currently I'll use this
                if ((command.length > 4) && (params[0] == "ECHO")) {
                    // addLine("echoing...");
                    var strLine = command.substring(5);
                    var word = "";
                    var override = false;

                    for (var i = 0; i < strLine.length; i++) {
                        if (strLine[i] == '"') {
                            // addLine("You're using quotation marks!");
                            i++;
                            override = true;

                            while (override) {
                                if (strLine[i] == '"') {
                                    // addLine("...end of quote reached!");
                                    override = false;
                                } else {
                                    word += strLine[i];
                                }

                                i++;
                            }

                        } else {
                            if (strLine[i] != " ") {
                                word += strLine[i];
                            } else {
                                i = strLine.length;
                            }
                        }
                    }

                    addLine(word);
                }
                else if ((command.length > 5) && (params[0] == "PAUSE")) {
                    pause(params[1]);
                }
                else if (params[0] == "CLEAR") {
                    clearAllLines();
                }
                else if ((command.length > 5) && (params[0] == "BATCH")) {
                    // Need to load the script first!

                    var began = false;
                    for (var i = 0; i < currentScript.length; i++) {
                        // Parse the line
                        var strLine = currentScript[i];
                        var line = [];
                        var word = "";
                        var override = false;
                        for (var j = 0; j < strLine.length; j++) {
                            if (strLine[j] == '"') {
                                j++;
                                override = true;
                                // just start a while loop and override j variable at end (don't lose count of position!)
                                while (override) {
                                    if (strLine[j] == '"') {
                                        override = false;
                                    } else {
                                        word += strLine[j];
                                    }

                                    j++;
                                }
                            } else {
                                if (strLine[j] != " ") {
                                    word += strLine[j];
                                } else {
                                    line.push(word);
                                    word = "";
                                }
                            }

                        }

                        /* Run the commands
                        * Define my script language which BATCH can run:
                        * start with BEGIN "program-name"
                        * PAUSE
                        * INPUT captures input into first following parameter variable, 
                        * ECHO captures only the first following parameter, but includes everything in ""'s
                        * REM indicates comments
                        * IF has 3 parameters: item0, operator, item1
                        * ELSE has no parameters
                        * ENDIF has no parameters
                        * GOTO  has 1 parameter: line nbr to go to next. If inside an IF, end the IF then go to line
                        * EXIT ends the program, anything after is ignored (typically follow with "program-name")
                        * needs an outlet for errors
                        */
                        if ((i == 0) && (line[0] == "BEGIN")) {
                            i = currentScript.length;
                        }
                        else if (line[0] == "EXIT") {
                            i = currentScript.length;
                        }
                        else if (line[0] == "PAUSE") {
                            //var result = pause(line[1]);
                            //if (result == 1) {
                            //    i = currentScript.length;
                            //}
                        }
                        else if (line[0] == "INPUT") {

                        }
                        else if (line[0] == "ECHO") {
                            addLine(line[1]);
                        }
                        else if (line[0] == "REM") {

                        }
                        else if (line[0] == "IF") {
                            // take the conditional, add another for loop that parses through the next loop (recursion?)
                        }
                        else if (line[0] == "ENDIF") {
                            // what do I do to end an IF?
                        }
                        else {
                            addLine("AN ERROR OCCURRED.");
                            i = currentScript.length;
                        }
                    }
                }

                //how do I allow user input inside programs?
            };

            var registerCommand = function (text) {
                var matched = false;
                var params = text.split(' ');
                for (var i = 0; i < commands.length; i++) {
                    if (params[0] == commands[i] && !matched) {
                        executeCommand(text);
                        matched = true;
                    }
                }
                if (!matched) {
                    addLine("SYNTAX ERROR.");
                }
            };

            // Capture keypress
            // from http://stackoverflow.com/questions/3729034/javascript-html5-capture-keycode-and-write-to-canvas
            // Had to switch .onkeypress event to .onkeydown so as to capture backspace.
            terminal.onkeypress = function (evt) {
                var charCode = evt.which;
                if (charCode == 13) {
                    addLine("> " + currentLine);
                    registerCommand(currentLine);
                    currentLine = "";
                } else if ((charCode > 36) && (charCode < 41)) {
                    // left is 37, up is 38, right is 39, and down is 40
                } else if (charCode >= 32) {
                    var charStr = String.fromCharCode(charCode);
                    currentLine += charStr;
                } else {
                    //currentLine = charCode;
                }
            };

            terminal.onkeydown = function (evt) {
                var charCode = evt.which;

                if (charCode == 8) {
                    currentLine = currentLine.substring(0, currentLine.length - 1);
                }
            };

        </script>
    </body>
</html>
